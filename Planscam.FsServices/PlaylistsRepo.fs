namespace Planscam.FsServices


open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq
open System.Collections.Generic
open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.FSharp.Core
open Planscam.DataAccess
open Planscam.Entities
open System.Linq

type PlaylistsRepo(dataContext: AppDbContext, userManager: UserManager<User>, signInManager: SignInManager<User>) =

    let userId user = userManager.GetUserId user
    let mutable _userQueryable = None

    let userQueryable userPrincipal =
        match _userQueryable with
        | Some r -> r
        | None ->
            let value =
                dataContext.Users.Where(fun user -> user.Id = userId userPrincipal)

            _userQueryable <- Some(value)
            value

    member _.GetLikedPlaylists(userPrincipal) =
        userQueryable(userPrincipal)
            .Select(fun user -> user.Playlists)
            .FirstAsync()

    member _.GetFavouriteTracksId(userPrincipal) =
        userQueryable(userPrincipal)
            .AsNoTracking()
            .Select(fun user -> user.FavouriteTracks.Id)
            .FirstAsync()

    member _.GetPlaylistFull(id, userPrincipal) =
        (if signInManager.IsSignedIn(userPrincipal) then
             (query {
                 for playlist in dataContext.Playlists do
                     where (playlist.Id = id)

                     select (
                         Playlist(
                             Id = playlist.Id,
                             Name = playlist.Name,
                             Picture = playlist.Picture,
                             Tracks =
                                 (query {
                                     for track in playlist.Tracks do
                                         select (
                                             Track(
                                                 Id = track.Id,
                                                 Name = track.Name,
                                                 Picture = track.Picture,
                                                 Author = track.Author,
                                                 IsLiked =
                                                     (query {
                                                         for user in userQueryable userPrincipal do
                                                             select (user.FavouriteTracks.Tracks.Contains(track))
                                                      })
                                                         .First()
                                             )
                                         )
                                  })
                                     .ToList(),
                             IsLiked =
                                 (query {
                                     for user in userQueryable userPrincipal do
                                         select (user.Playlists.Any(fun p -> p = playlist))
                                  })
                                     .First(),
                             IsOwned =
                                 (query {
                                     for user in userQueryable userPrincipal do
                                         select (user.OwnedPlaylists.Playlists.Any(fun p -> p = playlist))
                                  })
                                     .First()
                         )
                     )
              })
         else
             (query {
                 for playlist in dataContext.Playlists do
                     where (playlist.Id = id)

                     select (
                         Playlist(
                             Id = playlist.Id,
                             Name = playlist.Name,
                             Picture = playlist.Picture,
                             Tracks =
                                 (query {
                                     for track in playlist.Tracks do
                                         select (
                                             Track(
                                                 Id = track.Id,
                                                 Name = track.Name,
                                                 Picture = track.Picture,
                                                 Author = track.Author
                                             )
                                         )
                                  })
                                     .ToList()
                         )
                     )
              }))
            .AsNoTracking()
            .FirstOrDefaultAsync()

    member _.LikePlaylist(userPrincipal, id) =
        match (query {
                   for playlist in dataContext.Playlists do
                       where (playlist.Id = id)
               })
            .FirstOrDefault() with
        | null -> false
        | playlist ->
            userQueryable(userPrincipal)
                .Include(fun user -> user.Playlists.Where(fun _ -> false))
                .First()
                .Playlists.Add(playlist)

            dataContext.SaveChanges() |> ignore
            true

    member _.UnlikePlaylist(userPrincipal, id) =
        let user =
            userQueryable(userPrincipal)
                .Include(fun user -> user.Playlists.Where(fun playlist -> playlist.Id = id))
                .First()

        if user.Playlists.Any() then
            user.Playlists.Clear()
            dataContext.SaveChanges() |> ignore
            true
        else
            false

    member _.CreatePlaylist(userPrincipal, name, picture) =
        let user =
            (query {
                for user in
                    userQueryable(userPrincipal)
                        .Include(fun user -> user.OwnedPlaylists.Playlists) do
                    select (User(Id = user.Id, OwnedPlaylists = user.OwnedPlaylists))
             })
                .First()

        let playlist =
            Playlist(Name = name, Picture = picture, Users = List<User>())

        playlist.Users.Add user
        user.OwnedPlaylists.Playlists.Add playlist
        dataContext.SaveChanges() |> ignore
        playlist

    member _.DeletePlaylist(userPrincipal, id) =
        let playlist =
            dataContext
                .Playlists
                .Where(fun playlist ->
                    playlist.Id = id
                    && userQueryable(userPrincipal)
                        .Select(fun user -> user.OwnedPlaylists.Playlists)
                        .Any(fun playlists -> playlists.Contains(playlist)))
                .Select(fun playlist -> Playlist(Id = playlist.Id))
                .FirstOrDefault()

        if playlist = null then
            false
        else
            dataContext.Playlists.Remove playlist |> ignore
            dataContext.SaveChanges() |> ignore
            true
        